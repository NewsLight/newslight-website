<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>News Light</title>
    <link rel="icon" href="/favicon.ico" />

    <meta property="og:site_name" content="News Light" />
    <meta property="og:type" content="article" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              serif: ['Playfair Display', 'Georgia', 'serif'],
              sans: ['Inter', 'system-ui', 'sans-serif'],
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-neutral-950 text-white min-h-screen font-sans antialiased">

    <!-- Nav -->
    <nav class="max-w-5xl mx-auto px-6 py-8 flex items-center justify-between">
      <a href="/" class="font-serif text-2xl font-bold tracking-tight hover:text-neutral-300 transition-colors">News Light</a>
    </nav>

    <!-- Content rendered by JS -->
    <main id="content" class="max-w-2xl mx-auto px-6 py-16"></main>

    <!-- Footer -->
    <footer class="max-w-5xl mx-auto px-6 py-12 border-t border-neutral-800">
      <p class="text-neutral-500 text-sm text-center">&copy; 2025 News Light. All rights reserved.</p>
    </footer>

    <script>
      (function () {
        var UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        var path = window.location.pathname.replace(/\/+$/, '');
        var parts = path.split('/');
        // Match /article/{uuid}
        if (parts.length === 3 && parts[1] === 'article' && UUID_RE.test(parts[2])) {
          showArticlePage(parts[2]);
        } else {
          showNotFound();
        }

        function showNotFound() {
          document.title = 'Page Not Found — News Light';
          document.getElementById('content').innerHTML =
            '<div class="text-center py-20">' +
              '<h1 class="font-serif text-5xl font-bold mb-4">Page Not Found</h1>' +
              '<p class="text-neutral-400 text-lg mb-8">The page you\'re looking for doesn\'t exist.</p>' +
              '<a href="/" class="inline-block bg-white text-neutral-950 font-semibold text-sm px-8 py-4 rounded-full hover:bg-neutral-200 transition-colors">Back to Home</a>' +
            '</div>';
        }

        function showArticlePage(uuid) {
          var deepLink = 'newslight://app/news/' + uuid;
          var apiUrl = 'https://skykbtnscepbkerzcqlq.supabase.co/functions/v1/news/articles/' + uuid + '/preview';
          var apiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNreWtidG5zY2VwYmtlcnpjcWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3OTE3ODYsImV4cCI6MjA4MjM2Nzc4Nn0.I9Uk1M_Hc3V5LPsbYmZMqDjkl1qfDvR7pqXcMtZqmpo';

          // Show loading state
          document.getElementById('content').innerHTML =
            '<div class="text-center py-20">' +
              '<div class="inline-block w-8 h-8 border-2 border-neutral-600 border-t-white rounded-full animate-spin"></div>' +
              '<p class="text-neutral-400 mt-4">Loading article…</p>' +
            '</div>';

          // Attempt deep link after a short delay
          setTimeout(function () {
            window.location.href = deepLink;
          }, 1500);

          // Fetch article preview
          fetch(apiUrl, {
            headers: { 'apikey': apiKey }
          })
            .then(function (res) {
              if (!res.ok) throw new Error('Not found');
              return res.json();
            })
            .then(function (article) {
              var headline = article.headline || article.title || 'Untitled Article';
              var summary = article.summary || article.description || '';
              var city = article.city_name || article.city || '';

              document.title = headline + ' — News Light';

              // Update OG tags dynamically (helps with some crawlers)
              setMeta('og:title', headline + ' — News Light');
              if (summary) setMeta('og:description', summary);
              setMeta('og:url', window.location.href);

              document.getElementById('content').innerHTML =
                '<article class="py-8">' +
                  (city ? '<p class="text-sm font-medium text-neutral-500 uppercase tracking-wider mb-4">' + escapeHtml(city) + '</p>' : '') +
                  '<h1 class="font-serif text-3xl md:text-5xl font-bold leading-tight mb-6">' + escapeHtml(headline) + '</h1>' +
                  (summary ? '<p class="text-lg text-neutral-400 leading-relaxed mb-10">' + escapeHtml(summary) + '</p>' : '') +
                  '<div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-8 text-center mb-12">' +
                    '<p class="text-neutral-400 mb-6">This article is available exclusively in the News Light app</p>' +
                    '<a href="' + deepLink + '" class="inline-block bg-white text-neutral-950 font-semibold px-8 py-4 rounded-full hover:bg-neutral-200 transition-colors mb-3">Open in News Light</a>' +
                  '</div>' +
                  '<div class="text-center">' +
                    '<h2 class="font-serif text-2xl font-bold mb-3">Download the App</h2>' +
                    '<p class="text-neutral-400 mb-6">Get the full story and more local news in News Light.</p>' +
                    '<a href="#" class="inline-block bg-white text-neutral-950 font-semibold text-sm px-8 py-4 rounded-full hover:bg-neutral-200 transition-colors">Download on the App Store</a>' +
                  '</div>' +
                '</article>';
            })
            .catch(function () {
              document.title = 'Article — News Light';
              document.getElementById('content').innerHTML =
                '<div class="py-8 text-center">' +
                  '<h1 class="font-serif text-3xl md:text-4xl font-bold mb-4">Read This Article in News Light</h1>' +
                  '<p class="text-neutral-400 text-lg mb-8">This article is available exclusively in the News Light app.</p>' +
                  '<div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-8 mb-12">' +
                    '<a href="' + deepLink + '" class="inline-block bg-white text-neutral-950 font-semibold px-8 py-4 rounded-full hover:bg-neutral-200 transition-colors mb-3">Open in News Light</a>' +
                  '</div>' +
                  '<div>' +
                    '<h2 class="font-serif text-2xl font-bold mb-3">Download the App</h2>' +
                    '<p class="text-neutral-400 mb-6">Get local news, powered by AI.</p>' +
                    '<a href="#" class="inline-block bg-white text-neutral-950 font-semibold text-sm px-8 py-4 rounded-full hover:bg-neutral-200 transition-colors">Download on the App Store</a>' +
                  '</div>' +
                '</div>';
            });
        }

        function escapeHtml(str) {
          var div = document.createElement('div');
          div.appendChild(document.createTextNode(str));
          return div.innerHTML;
        }

        function setMeta(property, content) {
          var el = document.querySelector('meta[property="' + property + '"]');
          if (el) {
            el.setAttribute('content', content);
          } else {
            el = document.createElement('meta');
            el.setAttribute('property', property);
            el.setAttribute('content', content);
            document.head.appendChild(el);
          }
        }
      })();
    </script>
  </body>
</html>
